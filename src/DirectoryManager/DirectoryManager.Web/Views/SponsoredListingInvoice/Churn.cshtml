@model DirectoryManager.Web.Models.Reports.ChurnReportViewModel
@using DirectoryManager.Web.Constants

@{
    ViewData[StringConstants.TitleHeader] = ViewData[StringConstants.TitleHeader] ?? "Churn Report";
    Layout = "_CenteredLayout";

    // show inclusive end day in the date picker
    var startDate = Model.WindowStartUtc.ToUniversalTime().ToString("yyyy-MM-dd");
    var endDate = Model.WindowEndOpenUtc.AddDays(-1).ToUniversalTime().ToString("yyyy-MM-dd");

    // derive start-cohort churn and retention directly from lists/counters
    var churnedFromStart = Model.Churned?.Count() ?? 0; // Churned = START-COHORT losses
    var activatedCount = Model.Activated?.Count() ?? 0;

    decimal? churnRate = null;
    decimal? retentionRate = null;
    if (Model.ActiveAtStart > 0)
    {
        churnRate = (decimal)churnedFromStart / Model.ActiveAtStart;
        retentionRate = 1m - churnRate.Value;
    }
}

@section PageContent {
    <h1>@ViewData[StringConstants.TitleHeader]</h1>

    @await Html.PartialAsync("_AdminMenu")
    @await Html.PartialAsync("_ReportMenu")

    <hr />

    <form method="get" asp-action="Churn" asp-controller="SponsoredListingInvoice" class="form-inline mb-3">
        <div class="form-row">
            <div class="form-group mr-3">
                <label for="startDate" class="mr-2">Start</label>
                <input type="date" id="startDate" name="startDate" class="form-control" value="@startDate" />
            </div>

            <div class="form-group mr-3">
                <label for="endDate" class="mr-2">End</label>
                <input type="date" id="endDate" name="endDate" class="form-control" value="@endDate" />
            </div>

            <div class="form-group mr-3">
                <label for="sponsorshipType" class="mr-2">Type</label>
                <select id="sponsorshipType" name="sponsorshipType" class="form-control">
                    @foreach (var opt in Model.SponsorshipTypeOptions)
                    {
                        <option value="@opt.Value" selected="@(opt.Selected ? "selected" : null)">@opt.Text</option>
                    }
                </select>
            </div>

            <div class="form-group mr-3">
                <label for="categoryId" class="mr-2">Category</label>
                <select id="categoryId" name="categoryId" class="form-control">
                    @foreach (var opt in Model.CategoryOptions)
                    {
                        <option value="@opt.Value" selected="@(opt.Selected ? "selected" : null)">@opt.Text</option>
                    }
                </select>
            </div>

            <div class="form-group mr-3">
                <label for="subCategoryId" class="mr-2">Subcategory</label>
                <select id="subCategoryId" name="subCategoryId" class="form-control">
                    @foreach (var opt in Model.SubCategoryOptions)
                    {
                        <option value="@opt.Value" selected="@(opt.Selected ? "selected" : null)">@opt.Text</option>
                    }
                </select>
            </div>

            <div class="form-group mr-3">
                <button type="submit" class="btn btn-primary">Run</button>
            </div>
        </div>
    </form>

    <div class="mb-3">
        <strong>Window:</strong>
        @Model.WindowStartUtc.ToUniversalTime().ToString("yyyy-MM-dd")
        &rarr;
        @Model.WindowEndOpenUtc.AddDays(-1).ToUniversalTime().ToString("yyyy-MM-dd")
        <br />
        <strong>Type:</strong> @(Model.SponsorshipType?.ToString() ?? "All")
        &nbsp;|&nbsp;
        <strong>CategoryId:</strong> @(Model.CategoryId?.ToString() ?? "All")
        &nbsp;|&nbsp;
        <strong>SubCategoryId:</strong> @(Model.SubCategoryId?.ToString() ?? "All")
    </div>

    <hr />

    <!-- Big KPI line (START-COHORT percentages) -->
    <p class="lead mb-1">
        <strong>Churn rate (Churned ÷ Active @@ start):</strong>
        @(churnRate.HasValue? churnRate.Value.ToString("P2") : "N/A")
    </p>
    <p class="mb-4">
        <strong>Retention rate (start cohort):</strong>
        @(retentionRate.HasValue? retentionRate.Value.ToString("P2") : "N/A")
    </p>

    <div class="table-responsive">
        <table class="table table-bordered w-auto">
            <thead class="thead-light">
                <tr>
                    <th>Active @@ start</th>
                    <th>Activated (in window)</th>
                    <th>Churned (start cohort)</th>
                    <th>Active @@ end</th>
                    <th>Unique active in window</th>
                    <th>Churn rate (start cohort)</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>@Model.ActiveAtStart</td>
                    <td>@activatedCount</td>
                    <td>@churnedFromStart</td>
                    <td>@Model.ActiveAtEnd</td>
                    <td>@Model.UniqueActiveInWindow</td>
                    <td>@(churnRate.HasValue? churnRate.Value.ToString("P2") : "N/A")</td>
                </tr>
            </tbody>
        </table>
    </div>

    <hr />

    <h3>Activated in Window (@activatedCount)</h3>
    <div class="table-wrapper">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Advertiser</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.Activated != null && Model.Activated.Any())
                {
                    foreach (var row in Model.Activated.OrderBy(r => r.DirectoryEntryName))
                    {
                        <tr>
                            <td>@row.DirectoryEntryName</td>
                            <td>
                                <a href="@Url.Action("Advertiser", "SponsoredListingInvoice", new { directoryEntryId = row.DirectoryEntryId })">View invoices</a>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr><td colspan="2"><em>None</em></td></tr>
                }
            </tbody>
        </table>
    </div>

    <h3>Churned (Start Cohort) (@churnedFromStart)</h3>
    <div class="table-wrapper">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Advertiser</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.Churned != null && Model.Churned.Any())
                {
                    foreach (var row in Model.Churned.OrderBy(r => r.DirectoryEntryName))
                    {
                        <tr>
                            <td>@row.DirectoryEntryName</td>
                            <td>
                                <a href="@Url.Action("Advertiser", "SponsoredListingInvoice", new { directoryEntryId = row.DirectoryEntryId })">View invoices</a>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr><td colspan="2"><em>None</em></td></tr>
                }
            </tbody>
        </table>
    </div>
}