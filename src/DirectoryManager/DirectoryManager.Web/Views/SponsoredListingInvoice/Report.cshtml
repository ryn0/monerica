@model DirectoryManager.Web.Models.InvoiceQueryViewModel
@using DirectoryManager.Web.Constants;
@using System.Globalization

@{
    ViewData[StringConstants.TitleHeader] = "Sponsored Listing Invoice Report";
    Layout = "_CenteredLayout";

    // cache-buster so charts refresh when filters change
    var chartV = $"{Model.StartDate.Ticks}-{Model.EndDate.Ticks}-{(Model.SponsorshipType?.ToString() ?? "all")}-{(Model.SubCategoryId?.ToString() ?? "all")}-{Model.DisplayCurrency}";
}

@section PageContent {
    <h1>@ViewData[StringConstants.TitleHeader]</h1>

    @await Html.PartialAsync("_AdminMenu")
    @await Html.PartialAsync("_ReportMenu")

    <hr />

    <form method="get" asp-controller="SponsoredListingInvoice" asp-action="Report">
        <div class="form-row">
            <div class="form-group col-md-3">
                <label for="SponsorshipType">Sponsorship Type</label>
                <select id="SponsorshipType"
                        name="sponsorshipType"
                        class="form-control"
                        asp-items="Model.SponsorshipTypeOptions">
                </select>
            </div>

            <div class="form-group col-md-3">
                <label for="StartDate">Start Date</label>
                <input id="StartDate" name="startDate" type="date" class="form-control"
                       value="@Model.StartDate.ToString(DirectoryManager.Common.Constants.StringConstants.DateFormat)" required />
            </div>

            <div class="form-group col-md-3">
                <label for="EndDate">End Date</label>
                <input id="EndDate" name="endDate" type="date" class="form-control"
                       value="@Model.EndDate.ToString(DirectoryManager.Common.Constants.StringConstants.DateFormat)" required />
            </div>

            <div class="form-group col-md-3">
                <label for="DisplayCurrency">Display Currency</label>
                <select id="DisplayCurrency"
                        name="displayCurrency"
                        class="form-control"
                        asp-items="Model.DisplayCurrencyOptions">
                </select>
            </div>
        </div>

        <!-- Subcategory filter -->
        <div class="form-row">
            <div class="form-group col-md-6">
                <label for="SubCategoryId">Subcategory</label>
                <select id="SubCategoryId"
                        name="subCategoryId"
                        class="form-control"
                        asp-items="Model.SubCategoryOptions">
                </select>
            </div>
        </div>

        <button type="submit" class="btn btn-primary">Get Totals</button>
    </form>

    <br />

    <p>
        Time Range:
        @Model.StartDate.ToString(DirectoryManager.Common.Constants.StringConstants.DateTimeFormat)
        -
        @Model.EndDate.ToString(DirectoryManager.Common.Constants.StringConstants.DateTimeFormat)
    </p>

    <p>
        <strong>Total in @Model.DisplayCurrency:</strong>
        @if (Model.DisplayCurrency == DirectoryManager.Data.Enums.Currency.USD)
        {
            @Model.TotalInDisplayCurrency.ToString("C", CultureInfo.CreateSpecificCulture(StringConstants.EnglishUS))
        }
        else
        {
            @Model.TotalInDisplayCurrency.ToString("0.######") @Model.DisplayCurrency
        }
    </p>

    <!-- ========= NEW: Always-visible Averages panel ========= -->
    <div class="alert alert-secondary" style="padding:10px 14px; line-height:1.3;">
        <strong>Averages</strong>
        <div style="margin-top:6px;">
            @* If viewing USD, show average XMR price and implied XMR total *@
            @if (Model.DisplayCurrency == DirectoryManager.Data.Enums.Currency.USD)
            {
                <div>
                    Avg XMR price (weighted): 
                    @if (Model.AverageUsdPerXmr.HasValue)
                    {
                        @Model.AverageUsdPerXmr.Value.ToString("C", CultureInfo.CreateSpecificCulture(StringConstants.EnglishUS))
                        <span> per 1 XMR</span>
                    }
                    else
                    {
                        <span class="text-muted">— no XMR-denominated invoices in range</span>
                    }
                </div>

                <div>
                    Implied total at avg price: 
                    @if (Model.ImpliedTotalInXmrAtAvg.HasValue)
                    {
                        @Model.ImpliedTotalInXmrAtAvg.Value.ToString("0.######") <span> XMR</span>
                    }
                    else
                    {
                        <span class="text-muted">— n/a</span>
                    }
                </div>
            }
            else
            {
                @* If viewing a non-USD currency, show average USD per 1 unit of that currency *@
                <div>
                    Avg FX (weighted): 
                    @if (Model.AverageUsdPerUnitForDisplayCurrency.HasValue)
                    {
                        <span>1 @Model.DisplayCurrency ≈ </span>
                        @Model.AverageUsdPerUnitForDisplayCurrency.Value.ToString("C", CultureInfo.CreateSpecificCulture(StringConstants.EnglishUS)) <span> USD</span>
                    }
                    else
                    {
                        <span class="text-muted">— no invoices in @Model.DisplayCurrency in range</span>
                    }
                </div>
            }
        </div>
    </div>
    <!-- ========= /Averages panel ========= -->

    <p>
        <strong>Prepaid future services:</strong>
        @if (Model.PaidThroughDateUtc.HasValue && Model.FutureServiceDaysDistinct > 0)
        {
            <span>@Model.PaidThroughDateYmd — </span>
            @if (Model.DisplayCurrency == DirectoryManager.Data.Enums.Currency.USD)
            {
                @Model.FutureRevenueInDisplayCurrency.ToString("C", CultureInfo.CreateSpecificCulture(StringConstants.EnglishUS))
            }
            else
            {
                @Model.FutureRevenueInDisplayCurrency.ToString("0.######") @Model.DisplayCurrency
            }
            <span> for @Model.FutureServiceDaysDistinct day(s) remaining</span>
        }
        else
        {
            <span>none</span>
        }
    </p>

    <a 
       href="@Url.Action("DownloadAccountantCsv", "SponsoredListingInvoice", new {
            startDate = Model.StartDate.ToString(DirectoryManager.Common.Constants.StringConstants.DateTimeFormat),
            endDate   = Model.EndDate.ToString(DirectoryManager.Common.Constants.StringConstants.DateTimeFormat),
            sponsorshipType = Model.SponsorshipType?.ToString(),
            subCategoryId = Model.SubCategoryId,
            costEqualsSalesPrice = true
       })" target="_blank">Download Accounting CSV</a>

    <!-- Monthly Income (total) -->
    <img style="width:100%"
         src="@Url.Action("MonthlyIncomeBarChart", "SponsoredListingInvoice", new {
                startDate = Model.StartDate,
                endDate = Model.EndDate,
                sponsorshipType = Model.SponsorshipType,
                displayCurrency = Model.DisplayCurrency,
                subCategoryId = Model.SubCategoryId,
                v = chartV
         })"
         alt="Monthly Income Chart (@Model.DisplayCurrency)" />

    <br />

    <!-- Average Daily Revenue across the slot -->
    <img style="width:100%"
         src="@Url.Action("MonthlyAvgDailyRevenueChart", "SponsoredListingInvoice", new {
                startDate = Model.StartDate,
                endDate = Model.EndDate,
                sponsorshipType = Model.SponsorshipType,
                displayCurrency = Model.DisplayCurrency,
                subCategoryId = Model.SubCategoryId,
                v = chartV
         })"
         alt="Average Daily Revenue per Month (@Model.DisplayCurrency)" />

    <br />

 
    <div class="text-muted" style=" font-size:0.95rem;">
        Avg daily price <em>per listing</em> (weighted by how many days each listing was active in the month)
    </div>
    <br />
    <img style="width:100%"
         src="@Url.Action("MonthlyAvgPerListingDailyPriceChart", "SponsoredListingInvoice", new {
                startDate = Model.StartDate,
                endDate = Model.EndDate,
                sponsorshipType = Model.SponsorshipType,
                displayCurrency = Model.DisplayCurrency,
                subCategoryId = Model.SubCategoryId,
                v = chartV
         })"
         alt="Average Daily Price per Listing (@Model.DisplayCurrency)" />
   

    <br />

    <img style="width:100%"
         src="@Url.Action("SubcategoryRevenuePieChart", "SponsoredListingInvoice", new {
                startDate = Model.StartDate,
                endDate = Model.EndDate,
                sponsorshipType = Model.SponsorshipType,
                displayCurrency = Model.DisplayCurrency,
                subCategoryId = Model.SubCategoryId,
                v = chartV
         })"
         alt="Subcategory Revenue Pie Chart (@Model.DisplayCurrency)" />
}
